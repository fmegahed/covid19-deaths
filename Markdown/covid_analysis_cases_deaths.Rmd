---
title: "Modeling the Covariation between New Weekly Confirmed COVID-19 Cases and Deaths in the U.S. States: A Retrospective Analysis of 52 Weeks of Data"
author:
  - name: "Fadel M. Megahed ^[Email: fmegahed@miamioh.edu | Phone: +1-513-529-4185 | Website: <a href=\"https://miamioh.edu/fsb/directory/?up=/directory/megahefm\">Miami University Official</a>]"
    affiliation: Farmer School of Business, Miami University
bibliography: covidRefs.bib
csl: apa.csl
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    number_sections: TRUE
    theme: simplex
    paged_df: TRUE
    code_folding: show
    code_download: TRUE
  includes:
    in_header: structure.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = TRUE,
                      progress = FALSE, 
                      verbose = FALSE,
                      dpi = 300,
                      dev = c('png', 'postscript', 'tiff'),
                      out.width = '100%')
options(qwraps2_markup = "markdown")

library(ggplot2); theme_set(theme_bw(base_size = 10, base_family = "Arial"))
```

# R Setup and Required Packages
In this project, the open-source R programming language [@R2021] is used to model the progression in the COVID-19 pandemic in different U.S. counties. R is maintained by an international team of developers who make the language available at [The Comprehensive R Archive Network](https://cran.r-project.org/). Readers interested in reusing our code and reproducing our results should have R installed locally on their machines. R can be installed on a number of different operating systems (see [Windows](https://cran.r-project.org/bin/windows/), [Mac](https://cran.r-project.org/bin/macosx/), and [Linux](https://cran.r-project.org/bin/linux/) for the installation instructions for these systems). We also recommend using the RStudio interface for R. The reader can [download RStudio](http://www.rstudio.com/ide) for free by following the instructions at the link. For non-R users, we recommend the [Hands-on Programming with R](https://rstudio-education.github.io/hopr/packages.html) for a brief overview of the software's functionality. Hereafter, we assume that the reader has an introductory understanding of the R programming language.

In the code chunk below, we load the packages used to support our analysis. Note that the code of this and any of the code chunks can be hidden by clicking on the 'Hide' button to facilitate the navigation. **The reader can hide all code and/or download the Rmd file associated with this document by clicking on the Code button on the top right corner of this document.** 

```{r packages, cache=FALSE}
if(require(pacman)==FALSE) install.packages("pacman") # Install pacman (if not already installed)
if(require(devtools)==FALSE) install.packages("devtools") # Install devtools (if not already installed)

# to check and install if these packages are not found locally on machine
if(require(albersusa)==FALSE) devtools::install_github('hrbrmstr/albersusa') #install package if needed

pacman::p_load(tidyverse, tidyquant, magrittr, janitor, lubridate,  # for data analysis
               COVID19, # for extracting relevant data
               DT, pander, stargazer, knitr, # for formatting and nicely printed outputs
               scales, RColorBrewer, DataExplorer, tiff, grid,# for plots
               plotly, albersusa, tigris, leaflet, tmap, # for maps
               fpp2, tseries, timetk, sweep, # for time-series analysis
               conflicted) # for managing conflicts in functions with same names

# Handling conflicting function names from packages
conflict_prefer('combine', 'dplyr') # Preferring dplyr::combine over any other package
conflict_prefer('select', "dplyr") #Preferring dplyr::select over any other package
conflict_prefer("summarize", "dplyr") # similar to above but with dplyr::summarize
conflict_prefer("filter", "dplyr") # Preferring filter from dplyr
conflict_prefer("lag", "dplyr") # Preferring filter from dplyr

# Custom Functions
source('custom_functions.R')

set.seed(2021) # to assist with reproducibility
sInfo = sessionInfo() # saving all the packages/functions & session Info
```


# Extracting and Transforming the Data

In this code chunk, we capitalize on the [COVID-19 package](https://covid19datahub.io/) [@Guidotti2020] to extract the **cumulative daily** cases and deaths per U.S. state. Then, we perform the following transformations on the data: (a) we difference both confirmed cases and deaths to compute the new daily cases and deaths per location, (b) we aggregate the new confirmed cases and deaths by week, which we then store in the object `DATA`, and (c) we compute the ratio of deaths to cases to caputure how the pandemic has evolved over time in each of these counties. 

```{r covidData}
lastSatDate = (Sys.Date() - 1) %>% # we subtract 1 day in the calculation to ensure complete data
  floor_date(unit = 'week', week_start = 6) # flooring the date to correspond to Saturday

endDatePrintV = format(ymd(lastSatDate), format = "%b %d, %Y") # formatted for printing in charts

# we will focus our analysis on the 50 states + DC (hence we will exclude the locations below)
territories = c('American Samoa', 'Guam', 'Northern Mariana Islands','Puerto Rico', 'Virgin Islands')

# Extracting the COVID Data and Computing new daily cases and deaths
covidDF = covid19(country = "US", # we are limiting our analysis to the U.S. only
               level = 2, # state level data
               start = "2020-03-01", # First Sunday in March
               end = lastSatDate, # Data up to and including last Saturday
               raw = F, # no data cleaning (to have the same grid for all states)
               verbose = F) # do not print package citation information

covidDF %<>% filter(!administrative_area_level_2 %in% territories) %>%   # limiting to DC + 50 states
  select(id, administrative_area_level_2, date, confirmed, deaths) %>%  # limiting to relevant vars
  mutate(newDailyCases = confirmed - lag(confirmed), # computing new daily cases for each state
         newDailyDeath = deaths - lag(deaths))  # computing new daily death for each state
  

# Aggregating the new confirmed and death data by week
weeklyCases = covidDF %>% tq_transmute(select = newDailyCases, # converting the Data to Weekly
                                    mutate_fun = apply.weekly, # applying a weekly computation
                                    FUN= sum) # using the sum for computation
colnames(weeklyCases)[3] = 'newWeeklyCases' # changing name of value column to newWeeklyCases

weeklyDeath = covidDF %>% tq_transmute(select = newDailyDeath, # converting the Data to Weekly
                                    mutate_fun = apply.weekly, # applying a weekly computation
                                    FUN= sum) # using the sum for computation
colnames(weeklyDeath)[3] = 'newWeeklyDeath' # changing name of value column to newWeeklyDeath


# Generating the required dataset
DATA = left_join(weeklyCases, weeklyDeath, by = c('id', 'date')) %>% 
  inner_join(unique(covidDF[, c('id', 'administrative_area_level_2')]), by = 'id') %>% 
  arrange(administrative_area_level_2) %>% # sorting the df by alphabetical order of states
  relocate(administrative_area_level_2, .after = id) %>% # having the name after the id column 
  mutate(newWeeklyCases = ifelse(is.na(newWeeklyCases), 0, newWeeklyCases), # converting NA to zeros
         newWeeklyDeath = ifelse(is.na(newWeeklyDeath), 0, newWeeklyDeath), # converting NA to zeros
         newWeeklyRatio = newWeeklyDeath/newWeeklyCases)

DATA %<>% na.omit() # removing NA observations and storing it back in DATA
```

---

# References {-}

